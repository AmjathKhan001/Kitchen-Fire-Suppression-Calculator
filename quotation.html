<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Quotation | Kitchen Fire Suppression System</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-376208036"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-376208036');
    </script>
    
    <!-- Google AdSense Auto Ads -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6687860250561653" crossorigin="anonymous"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¥</text></svg>">
    
    <style>
        /* Minimal inline styles only for print controls positioning */
        .print-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .print-controls .btn {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        @media print {
            .print-controls,
            .explore-tools,
            .affiliate-banner,
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced Header -->
    <header class="quotation-header">
        <div class="container">
            <div class="header-content">
                <div>
                    <h1 class="quotation-title-main">QUOTATION</h1>
                    <div class="quote-number-badge" id="quoteNumberDisplay">Loading...</div>
                </div>
                <div class="print-controls no-print">
                    <button onclick="window.print()" class="btn btn-primary">
                        <i class="fas fa-print"></i> Print Quotation
                    </button>
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-calculator"></i> New Calculation
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="container">
            <ul>
                <li><a href="index.html"><i class="fas fa-calculator"></i> Calculator</a></li>
                <li><a href="results.html"><i class="fas fa-list-alt"></i> Results</a></li>
                <li class="active"><a href="quotation.html"><i class="fas fa-file-invoice-dollar"></i> Quotation</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container">
        <div class="quotation-container">
            <!-- Company & Client Info -->
            <div class="company-details-card">
                <div class="company-header">
                    <div class="company-logo">
                        <i class="fas fa-fire-extinguisher"></i>
                        <div class="company-info">
                            <h2>Fire Safety Solutions Ltd.</h2>
                            <p>Professional Kitchen Fire Suppression Systems</p>
                            <p><i class="fas fa-map-marker-alt"></i> 123 Safety Street, Fire City, FC 12345</p>
                            <p><i class="fas fa-phone"></i> (555) 123-4567 | <i class="fas fa-envelope"></i> info@firesafetysolutions.com</p>
                        </div>
                    </div>
                    <div class="quotation-meta" id="quotationMeta">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
                
                <div class="client-info-card">
                    <h3><i class="fas fa-user-tie"></i> Quotation For</h3>
                    <div class="client-details" id="clientDetails">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- System Summary -->
            <div class="card">
                <h3 class="card-title"><i class="fas fa-fire-extinguisher"></i> System Summary</h3>
                <div class="system-summary-cards" id="systemSummary">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
            
            <!-- Quotation Items Table -->
            <div class="card">
                <h3 class="card-title"><i class="fas fa-receipt"></i> Quotation Items</h3>
                
                <div class="quotation-table-container">
                    <table class="quotation-table" id="quotationTable">
                        <thead>
                            <tr>
                                <th width="50%">Description</th>
                                <th width="10%">Qty</th>
                                <th width="20%">Unit Price</th>
                                <th width="20%">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="quotationItems">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Total Display -->
                <div class="total-display" id="totalDisplay">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
            
            <!-- Terms & Conditions -->
            <div class="terms-section">
                <h3><i class="fas fa-file-contract"></i> Terms & Conditions</h3>
                
                <ul class="terms-list">
                    <li>This quotation is valid for <strong>30 days</strong> from the date of issue.</li>
                    <li>Prices are in the currency specified and include all standard components as listed.</li>
                    <li>Installation timeline: <strong>2-3 weeks</strong> from receipt of purchase order and 50% deposit.</li>
                    <li>Payment terms: <strong>50% advance payment</strong>, balance upon completion and commissioning.</li>
                    <li><strong>Warranty:</strong> 12 months on all parts and labor from date of commissioning.</li>
                    <li>Annual maintenance contract is recommended and available separately.</li>
                    <li>All work complies with <strong>NFPA 96</strong> and <strong>NFPA 17A</strong> standards.</li>
                    <li>Site-specific conditions may require adjustments to the system design and pricing.</li>
                    <li>Any changes to the scope of work after quotation acceptance may affect final price and timeline.</li>
                    <li>Installation includes basic operator training on system use and emergency procedures.</li>
                </ul>
                
                <div class="signature-area">
                    <div class="signature-box">
                        <h4>For Fire Safety Solutions Ltd.</h4>
                        <p>Authorized Representative</p>
                        <div class="signature-line"></div>
                        <p>Name: _________________________</p>
                        <p>Title: Project Manager</p>
                        <p>Date: _________________________</p>
                    </div>
                    
                    <div class="signature-box">
                        <h4>Accepted By Client</h4>
                        <p>Authorized Signature</p>
                        <div class="signature-line"></div>
                        <p>Name: _________________________</p>
                        <p>Title: _________________________</p>
                        <p>Date: _________________________</p>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 40px; text-align: center;">
                    <button onclick="window.print()" class="btn btn-primary btn-lg">
                        <i class="fas fa-print"></i> Print Quotation
                    </button>
                    <a href="results.html" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i> Back to Results
                    </a>
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-calculator"></i> New Calculation
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Explore Tools -->
        <section class="explore-tools">
            <h2><i class="fas fa-star"></i> Recommended Safety Tools</h2>
            <div class="tools-grid">
                <div class="tool-card">
                    <div class="tool-icon">ðŸ§¯</div>
                    <h3>Fire Extinguisher Calculator</h3>
                    <p>BIS 2190:2024 compliant calculator for determining exact fire extinguisher requirements.</p>
                    <a href="https://fire-extinguisher-calculator.vercel.app" target="_blank" class="tool-link">Try Tool</a>
                </div>
                <div class="tool-card">
                    <div class="tool-icon">ðŸ“‹</div>
                    <h3>Fire Safety Audit Tool</h3>
                    <p>Streamline fire safety inspections with automated audit reporting.</p>
                    <a href="https://fire-extinguisher-audit-tool.vercel.app" target="_blank" class="tool-link">Try Tool</a>
                </div>
                <div class="tool-card">
                    <div class="tool-icon">ðŸ”¥</div>
                    <h3>Fire Safety Assessment</h3>
                    <p>Complete fire safety risk assessment platform.</p>
                    <a href="https://firesafetyassessmenttool.vercel.app" target="_blank" class="tool-link">Try Tool</a>
                </div>
            </div>
        </section>
        
        <!-- Amazon Associates Banner -->
        <aside class="affiliate-banner">
            <a href="https://amzn.to/4p8ceG6" target="_blank" class="amazon-button">
                <span class="sale-badge">Clearance Sale! Up to 70% Off</span>
                <span class="banner-text">ðŸ”¥ Shop Fire Safety Equipment on Amazon</span>
                <i class="fas fa-bolt"></i>
            </a>
        </aside>
        
        <!-- Footer -->
        <footer>
            <div class="footer-content">
                <div class="footer-logo">
                    <i class="fas fa-fire-extinguisher"></i>
                    <span>Professional KFSS Calculator</span>
                </div>
                <div class="footer-disclaimer">
                    <p>Â© 2023 Fire Safety Solutions Ltd. | NFPA 96 & NFPA 17A Compliant | Professional Kitchen Fire Suppression Systems</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Quotation JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Quotation page loaded');
            generateQuotation();
        });

        function generateQuotation() {
            console.log('Generating quotation...');
            
            try {
                // Try multiple keys to find the data
                let saved = localStorage.getItem('kfss_quotation_data');
                if (!saved) {
                    saved = localStorage.getItem('kfss_last_calculation');
                }
                
                if (!saved) {
                    console.log('No calculation data found in localStorage');
                    showNoData();
                    return;
                }
                
                const calculation = JSON.parse(saved);
                console.log('Calculation data found:', calculation);
                
                // Validate calculation data
                if (!calculation.project || !calculation.results) {
                    console.error('Invalid calculation data structure');
                    showNoData();
                    return;
                }
                
                const currency = calculation.project.currency || 'USD';
                const symbol = {
                    'USD': '$',
                    'EUR': 'â‚¬',
                    'INR': 'â‚¹',
                    'AED': 'Ø¯.Ø¥'
                }[currency] || '$';
                
                const quoteNumber = 'Q-' + 
                    new Date(calculation.timestamp || Date.now()).getFullYear() + '-' +
                    String(new Date(calculation.timestamp || Date.now()).getMonth() + 1).padStart(2, '0') + '-' +
                    String(calculation.id || Date.now()).slice(-6);
                
                document.getElementById('quoteNumberDisplay').textContent = 'Quote #: ' + quoteNumber;
                
                const quoteDate = new Date(calculation.timestamp || Date.now());
                const validDate = new Date(quoteDate);
                validDate.setDate(validDate.getDate() + 30);
                
                document.getElementById('quotationMeta').innerHTML = `
                    <div class="date">${quoteDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                    <div class="valid-until">
                        <i class="fas fa-calendar-check"></i>
                        Valid until: ${validDate.toLocaleDateString()}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem;">
                        <i class="fas fa-money-bill-wave"></i> Currency: ${currency}
                    </div>
                `;
                
                document.getElementById('clientDetails').innerHTML = `
                    <div class="client-detail-item">
                        <strong>Client Name</strong>
                        ${calculation.project.client || 'Not specified'}
                    </div>
                    <div class="client-detail-item">
                        <strong>Project Name</strong>
                        ${calculation.project.name || 'Not specified'}
                    </div>
                    <div class="client-detail-item">
                        <strong>Project Location</strong>
                        ${calculation.project.location || 'To be specified'}
                    </div>
                    <div class="client-detail-item">
                        <strong>Calculation Reference</strong>
                        CALC-${calculation.id || 'N/A'}
                    </div>
                `;
                
                // Create system summary
                document.getElementById('systemSummary').innerHTML = `
                    <div class="summary-card-item">
                        <div class="label">Total Nozzles</div>
                        <div class="value">${calculation.results.nozzles?.total || 0}</div>
                        <div class="detail">
                            Plenum: ${calculation.results.nozzles?.plenum || 0}<br>
                            Duct: ${calculation.results.nozzles?.duct || 0}<br>
                            Appliances: ${calculation.results.nozzles?.appliances || 0}
                        </div>
                    </div>
                    <div class="summary-card-item">
                        <div class="label">Cylinders Required</div>
                        <div class="value">${calculation.results.cylinders || 0}</div>
                        <div class="detail">
                            ${(calculation.results.cylinders || 0) > 1 ? '10kg cylinders' : '5kg cylinder'}
                        </div>
                    </div>
                    <div class="summary-card-item">
                        <div class="label">Agent Weight</div>
                        <div class="value">${(calculation.results.agentWeight || 0).toFixed(1)} kg</div>
                        <div class="detail">Wet Chemical</div>
                    </div>
                    <div class="summary-card-item">
                        <div class="label">Piping Length</div>
                        <div class="value">${Math.round(calculation.results.pipingLength || 0)} m</div>
                        <div class="detail">${calculation.configuration?.system?.pipeMaterial || 'Galvanized'}</div>
                    </div>
                `;
                
                const subtotals = calculation.results.subtotals || {};
                const totalCost = calculation.results.totalCost || 0;
                const safetyFactor = calculation.configuration?.system?.safetyFactor || 10;
                
                // Create quotation table
                let tableHTML = '';
                
                tableHTML += `
                    <tr class="category-row">
                        <td colspan="4"><i class="fas fa-fire-extinguisher"></i> Kitchen Fire Suppression System Components</td>
                    </tr>
                    
                    <tr>
                        <td>Wet Chemical Cylinder System (${(calculation.results.cylinders || 0) > 1 ? '10kg' : '5kg'} cylinders)</td>
                        <td>${calculation.results.cylinders || 0}</td>
                        <td>${symbol}${((calculation.results.cylinders || 0) > 1 ? 1900 : 1200).toFixed(2)}</td>
                        <td>${symbol}${(subtotals.cylinders || 0).toFixed(2)}</td>
                    </tr>
                    
                    <tr>
                        <td>Discharge Nozzles (various types for plenum, duct & appliances)</td>
                        <td>${calculation.results.nozzles?.total || 0}</td>
                        <td>${symbol}85.00</td>
                        <td>${symbol}${(subtotals.nozzles || 0).toFixed(2)}</td>
                    </tr>
                    
                    <tr>
                        <td>Piping System (${calculation.configuration?.hood?.material || 'Galvanized'} steel)</td>
                        <td>${Math.round(calculation.results.pipingLength || 0)} m</td>
                        <td>${symbol}35.00/m</td>
                        <td>${symbol}${(subtotals.piping || 0).toFixed(2)}</td>
                    </tr>
                    
                    <tr>
                        <td>Hood & Agent Tank Assembly</td>
                        <td>1</td>
                        <td>${symbol}1800.00</td>
                        <td>${symbol}${(subtotals.hoodAgentTank || 0).toFixed(2)}</td>
                    </tr>
                    
                    <tr>
                        <td>Manual Release Station with Fusible Link Detectors</td>
                        <td>1</td>
                        <td>${symbol}250.00</td>
                        <td>${symbol}${(subtotals.manualRelease || 0).toFixed(2)}</td>
                    </tr>
                `;
                
                if (calculation.configuration?.appliances && calculation.configuration.appliances.length > 0) {
                    tableHTML += `
                        <tr class="category-row">
                            <td colspan="4"><i class="fas fa-utensils"></i> Appliance Protection</td>
                        </tr>
                    `;
                    
                    calculation.configuration.appliances.forEach(appliance => {
                        const price = appliance.price || 0;
                        const nozzles = appliance.nozzles || 1;
                        const unitPrice = price / nozzles;
                        tableHTML += `
                            <tr>
                                <td>${appliance.name || 'Appliance'} Protection System</td>
                                <td>${nozzles}</td>
                                <td>${symbol}${unitPrice.toFixed(2)}</td>
                                <td>${symbol}${price.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                }
                
                tableHTML += `
                    <tr class="category-row">
                        <td colspan="4"><i class="fas fa-tools"></i> Services</td>
                    </tr>
                    
                    <tr>
                        <td>Professional Installation & Labor</td>
                        <td>1</td>
                        <td>${symbol}850.00</td>
                        <td>${symbol}${(subtotals.installationLabor || 0).toFixed(2)}</td>
                    </tr>
                    
                    <tr>
                        <td>System Commissioning, Testing & Certification</td>
                        <td>1</td>
                        <td>${symbol}400.00</td>
                        <td>${symbol}${(subtotals.commissioning || 0).toFixed(2)}</td>
                    </tr>
                    
                    <tr class="total-row">
                        <td colspan="3" style="text-align: right;"><strong>SUBTOTAL</strong></td>
                        <td><strong>${symbol}${(totalCost / (1 + safetyFactor/100)).toFixed(2)}</strong></td>
                    </tr>
                    
                    <tr>
                        <td colspan="3" style="text-align: right;">Safety Margin (${safetyFactor}%)</td>
                        <td>${symbol}${(totalCost - (totalCost / (1 + safetyFactor/100))).toFixed(2)}</td>
                    </tr>
                    
                    <tr class="grand-total-row">
                        <td colspan="3" style="text-align: right;"><strong>TOTAL QUOTATION AMOUNT</strong></td>
                        <td><strong>${symbol}${totalCost.toFixed(2)}</strong></td>
                    </tr>
                `;
                
                document.getElementById('quotationItems').innerHTML = tableHTML;
                
                document.getElementById('totalDisplay').innerHTML = `
                    <div class="label">TOTAL QUOTATION VALUE</div>
                    <div class="amount">${symbol}${totalCost.toFixed(2)}</div>
                    <div class="note">In ${currency} â€¢ Valid until ${validDate.toLocaleDateString()}</div>
                `;
                
                console.log('Quotation generated successfully');
                
            } catch (error) {
                console.error('Error generating quotation:', error);
                console.error('Error stack:', error.stack);
                showNoData();
            }
        }

        function showNoData() {
            console.log('Showing no data message');
            const quotationContainer = document.querySelector('.quotation-container');
            if (quotationContainer) {
                quotationContainer.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-file-invoice-dollar" style="font-size: 4rem; color: var(--gray); margin-bottom: 20px;"></i>
                        <h2>No Quotation Data Available</h2>
                        <p style="margin-bottom: 30px; color: var(--gray-dark); max-width: 500px; margin-left: auto; margin-right: auto;">
                            Please perform a calculation first to generate a professional quotation.
                        </p>
                        <div class="action-buttons" style="display: flex; gap: 15px; justify-content: center;">
                            <a href="index.html" class="btn btn-primary btn-lg">
                                <i class="fas fa-calculator"></i> Go to Calculator
                            </a>
                            <a href="results.html" class="btn btn-outline">
                                <i class="fas fa-list-alt"></i> View Results
                            </a>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
