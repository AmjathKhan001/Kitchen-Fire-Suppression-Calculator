<!-- INLINE JAVASCRIPT -->
<script>
    // KFSS Calculator
    const KFSSCalculator = {
        // ... [keep all existing code until the performCalculation function] ...

        performCalculation: function() {
            const projectName = document.getElementById('projectName')?.value || 'Unnamed Project';
            const clientName = document.getElementById('clientName')?.value || 'Unnamed Client';
            const projectLocation = document.getElementById('projectLocation')?.value || '';
            const hoodLength = parseFloat(document.getElementById('hoodLength')?.value) || 0;
            const hoodDepth = parseFloat(document.getElementById('hoodDepth')?.value) || 0;
            const plenumSections = parseInt(document.getElementById('plenumSections')?.value) || 0;
            const ductSections = parseInt(document.getElementById('ductSections')?.value) || 0;
            const currency = document.getElementById('currency')?.value || 'USD';
            
            const hoodMaterial = document.getElementById('hoodMaterial')?.value || 'stainless';
            const ductLength = parseFloat(document.getElementById('ductLength')?.value) || 5.0;
            const nozzleType = document.getElementById('nozzleType')?.value || 'standard';
            const pipeMaterial = document.getElementById('pipeMaterial')?.value || 'galvanized';
            const safetyFactor = parseInt(document.getElementById('safetyFactor')?.value) || 10;
            const pressureRating = parseInt(document.getElementById('pressureRating')?.value) || 100;
            const additionalNotes = document.getElementById('additionalNotes')?.value || '';
            
            if (!projectName.trim() || !clientName.trim()) {
                alert('Please fill in Project Name and Client Name');
                return;
            }
            
            if (hoodLength <= 0 || hoodDepth <= 0) {
                alert('Please enter valid hood dimensions');
                return;
            }
            
            const warnings = this.SafetyFeatures.checkRequirements();
            if (warnings.length > 0) {
                const proceed = confirm(`There are ${warnings.length} safety recommendations. Do you want to proceed anyway?\n\nClick OK to continue, Cancel to review.`);
                if (!proceed) return;
            }
            
            const selectedAppliances = [];
            const selectedApplianceItems = document.querySelectorAll('.appliance-item.selected');
            
            selectedApplianceItems.forEach(item => {
                const applianceId = item.dataset.id;
                const appliance = this.standardAppliances.find(a => a.id === applianceId);
                if (appliance) {
                    selectedAppliances.push({
                        id: appliance.id,
                        name: appliance.name,
                        nozzles: appliance.nozzles,
                        price: appliance.price
                    });
                }
            });
            
            const hoodArea = hoodLength * hoodDepth;
            const applianceNozzles = selectedAppliances.reduce((sum, app) => sum + app.nozzles, 0);
            const totalNozzles = plenumSections + ductSections + applianceNozzles;
            const cylindersRequired = Math.ceil(totalNozzles / 6);
            const agentWeight = cylindersRequired * 5.7;
            const pipingLength = (totalNozzles * 2) + 5 + (this.expertMode ? ductLength : 0);
            
            let subtotalsUSD = {
                nozzles: totalNozzles * this.pricing.nozzle,
                cylinders: cylindersRequired * (cylindersRequired > 1 ? this.pricing.cylinder_10kg : this.pricing.cylinder_5kg),
                piping: pipingLength * this.pricing.piping_per_meter,
                hoodAgentTank: this.pricing.hood_agent_tank,
                manualRelease: this.pricing.manual_release,
                installationLabor: this.pricing.installation_labor,
                commissioning: this.pricing.commissioning,
                appliances: selectedAppliances.reduce((sum, app) => sum + app.price, 0)
            };
            
            const safetyMultiplier = 1 + (safetyFactor / 100);
            let subtotals = {};
            Object.keys(subtotalsUSD).forEach(key => {
                subtotals[key] = subtotalsUSD[key] * safetyMultiplier;
            });
            
            let totalCostUSD = Object.values(subtotals).reduce((sum, val) => sum + val, 0);
            
            const exchangeRate = this.exchangeRates[currency] || 1;
            let totalCost = totalCostUSD * exchangeRate;
            
            let subtotalsConverted = {};
            Object.keys(subtotals).forEach(key => {
                subtotalsConverted[key] = subtotals[key] * exchangeRate;
            });
            
            this.currentCalculation = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                project: {
                    name: projectName,
                    client: clientName,
                    location: projectLocation,
                    currency: currency
                },
                configuration: {
                    hood: {
                        length: hoodLength,
                        depth: hoodDepth,
                        area: hoodArea,
                        material: hoodMaterial,
                        plenumSections: plenumSections,
                        ductSections: ductSections,
                        ductLength: ductLength
                    },
                    appliances: selectedAppliances.map(app => ({
                        ...app,
                        price: app.price * exchangeRate
                    })),
                    system: {
                        nozzleType: nozzleType,
                        pipeMaterial: pipeMaterial,
                        safetyFactor: safetyFactor,
                        pressureRating: pressureRating,
                        additionalNotes: additionalNotes
                    }
                },
                results: {
                    nozzles: {
                        plenum: plenumSections,
                        duct: ductSections,
                        appliances: applianceNozzles,
                        total: totalNozzles
                    },
                    cylinders: cylindersRequired,
                    agentWeight: agentWeight,
                    pipingLength: pipingLength,
                    subtotals: subtotalsConverted,
                    totalCost: totalCost,
                    exchangeRate: exchangeRate,
                    baseTotalUSD: totalCostUSD,
                    safetyWarnings: warnings
                },
                // ADD THIS FOR QUOTATION PAGE COMPATIBILITY
                quotation: {
                    needsQuotation: true,
                    lastUpdated: new Date().toISOString()
                }
            };
            
            // SAVE WITH SPECIFIC KEY FOR QUOTATION PAGE
            localStorage.setItem('kfss_last_calculation', JSON.stringify(this.currentCalculation));
            localStorage.setItem('kfss_quotation_data', JSON.stringify(this.currentCalculation)); // ADD THIS LINE
            
            this.addToRecentCalculations(this.currentCalculation);
            this.updateRecentCalculationsDisplay();
            
            // Navigate to results page
            window.location.href = 'results.html';
        },

        // ... [rest of the code remains the same] ...
    };
</script>
